<!-- Expects the data context to have a `template` property (the name of
the template to render) and an optional `data` property. If the `data`
property is not specified, then the parent data context will be used
instead. Uses the __dynamicWithDataContext template below to actually
render the template. -->
<template name="__dynamic">
  {{checkContext}}
  {{#if dataContextPresent}}
    {{#if Template.contentBlock}}
      {{# __dynamicWithDataContext}}{{> Template.contentBlock}}{{/__dynamicWithDataContext}}
    {{else}}
      {{> __dynamicWithDataContext}}
    {{/if}}
  {{else}}
    {{! if there was no explicit 'data' argument, use the parent context}}
    {{#if Template.contentBlock}}
      {{# __dynamicWithDataContext template=template data=..}}{{> Template.contentBlock}}{{/__dynamicWithDataContext}}
    {{else}}
      {{> __dynamicWithDataContext template=template data=..}}
    {{/if}}
  {{/if}}
</template>

<!-- Expects the data context to have a `template` property (the name of
the template to render) and a `data` property, which can be falsey. -->
<template name="__dynamicWithDataContext">
  {{#with chooseTemplate template}}
    {{#if Template.contentBlock}}
      {{!-- The .. is evaluated inside {{#with ../data}} --}}
      {{# .. ../data}}{{> Template.contentBlock}}{{/ ..}}
    {{else}}
      {{> .. ../data}}    {{!-- The .. is evaluated inside {{#with ../data}} --}}
    {{/if}}
  {{/with}}
</template>
